<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5.1 is lots of fun by jaron dembsky</title>
    <!-- MathJax for rendering beautiful math -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Canvas Confetti for celebrations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --secondary: #a855f7;
            --accent: #ec4899;
            --background: #0f172a;
            --card-bg: #1e293b;
            --sidebar-bg: #1e293b;
            --text: #f8fafc;
            --success: #22c55e;
            --error: #ef4444;
            --border: rgba(255,255,255,0.1);
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, var(--background), #1e1b4b);
            color: var(--text);
            height: 100vh;
            margin: 0;
            overflow: hidden; /* Use internal scrolling */
            display: flex;
        }

        /* --- LAYOUT --- */
        .app-layout {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 300px;
            background: rgba(30, 41, 59, 0.95);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            overflow-y: auto;
            flex-shrink: 0;
            box-shadow: 4px 0 15px rgba(0,0,0,0.3);
        }

        .brand {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(to right, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.2rem;
            animation: float 3s ease-in-out infinite;
        }

        .author {
            font-size: 0.8rem;
            opacity: 0.6;
            margin-bottom: 2rem;
        }

        .menu-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--secondary);
            margin-bottom: 1rem;
            margin-top: 1rem;
            font-weight: bold;
        }

        .topic-item {
            margin-bottom: 1rem;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 10px;
            border: 1px solid var(--border);
        }

        .topic-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .topic-score {
            font-size: 0.75rem;
            background: rgba(0,0,0,0.3);
            padding: 2px 8px;
            border-radius: 10px;
            color: var(--success);
        }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        .sidebar-btn {
            flex: 1;
            padding: 6px;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }

        .btn-practice {
            background: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }
        .btn-practice:hover { background: var(--primary); color: white; }

        .btn-quiz {
            background: rgba(236, 72, 153, 0.2);
            color: #fbcfe8;
            border: 1px solid rgba(236, 72, 153, 0.3);
        }
        .btn-quiz:hover { background: var(--accent); color: white; }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            overflow-y: auto;
            position: relative;
        }

        .card {
            background: var(--card-bg);
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            border: 1px solid var(--border);
            width: 100%;
            max-width: 700px;
            text-align: center;
            position: relative;
        }

        /* --- QUIZ UI ELEMENTS --- */
        .mode-indicator {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.5);
            padding: 5px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            border: 1px solid var(--border);
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            margin-bottom: 1.5rem;
            overflow: hidden;
            display: none; /* Only show in quiz mode */
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            width: 0%;
            transition: width 0.3s ease;
        }

        .question-box {
            font-size: 2rem;
            margin: 2rem 0;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 1.5rem;
        }

        button.option-btn {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            color: var(--text);
            padding: 20px;
            border-radius: 12px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        button.option-btn:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-2px);
            border-color: var(--primary);
        }
        button.option-btn.correct { background: var(--success); border-color: var(--success); color: white; }
        button.option-btn.wrong { background: var(--error); border-color: var(--error); animation: shake 0.5s; }

        .next-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 2rem;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }
        .next-btn.show { opacity: 1; pointer-events: all; }
        .next-btn:hover { background: var(--secondary); transform: translateY(-2px); }

        /* --- RESULTS TABLE --- */
        .results-container {
            display: none; /* Hidden by default */
            width: 100%;
            max-width: 800px;
            animation: fadeIn 0.5s;
        }

        .results-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .results-header h2 { font-size: 2.5rem; margin: 0; color: var(--text); }
        .results-summary { font-size: 1.2rem; opacity: 0.8; margin-top: 0.5rem; }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid var(--border);
        }

        .data-table th, .data-table td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .data-table th {
            background: rgba(99, 102, 241, 0.2);
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
            color: #a5b4fc;
        }

        .data-table tr:hover { background: rgba(255,255,255,0.02); }
        .data-table tr:last-child td { border-bottom: none; }

        .status-icon { font-size: 1.2rem; }
        .status-check { color: var(--success); }
        .status-x { color: var(--error); }
        .time-pill { 
            background: rgba(255,255,255,0.1); 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-size: 0.8rem; 
        }

        .actions-row {
            margin-top: 2rem;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        /* --- ANIMATIONS --- */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }

        /* Mobile Responsive */
        @media (max-width: 800px) {
            .app-layout { flex-direction: column; overflow: auto; }
            .sidebar { width: 100%; max-height: 250px; border-right: none; border-bottom: 1px solid var(--border); }
            .main-content { padding: 1rem; }
            .options-grid { grid-template-columns: 1fr; }
            .data-table th, .data-table td { padding: 10px 5px; font-size: 0.9rem; }
        }
    </style>
</head>
<body>

<div class="app-layout">
    <!-- SIDEBAR -->
    <nav class="sidebar">
        <div class="brand">5.1 is lots of fun</div>
        <div class="author">by jaron dembsky</div>
        
        <div class="menu-label">Random Mix</div>
        <div class="topic-item">
            <div class="topic-header">
                <span>All Topics</span>
                <span class="topic-score" id="score-all">0/0</span>
            </div>
            <div class="btn-group">
                <button class="sidebar-btn btn-practice" onclick="startPractice('all')">Practice</button>
                <button class="sidebar-btn btn-quiz" onclick="startQuiz('all')">10 Q Quiz</button>
            </div>
        </div>

        <div class="menu-label">Categories</div>
        <div id="category-list">
            <!-- Items injected by JS -->
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        
        <!-- PRACTICE / QUIZ CARD -->
        <div class="card" id="question-card">
            <div class="mode-indicator" id="mode-badge">Practice Mode</div>
            <div class="progress-bar" id="quiz-progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span style="opacity: 0.6; font-size: 0.9rem;" id="current-category-display">Topic</span>
                <div style="background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold;">
                    Streak: <span id="streak">0</span>
                </div>
            </div>

            <div class="question-box fade-in" id="question-area">Select a topic to start!</div>

            <div class="options-grid" id="options-area">
                <!-- Options injected here -->
            </div>

            <button class="next-btn" id="next-btn" onclick="nextQuestion()">Next Problem ➔</button>
        </div>

        <!-- RESULTS TABLE (Hidden until quiz ends) -->
        <div class="results-container" id="results-view">
            <div class="results-header">
                <h2>Quiz Results</h2>
                <div class="results-summary" id="results-summary-text">Score: 8/10 | Total Time: 45s</div>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Question</th>
                        <th>Your Answer</th>
                        <th>Correct</th>
                        <th><span style="font-size:1.2rem">✓/✗</span></th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="results-body">
                    <!-- Rows injected here -->
                </tbody>
            </table>

            <div class="actions-row">
                <button class="sidebar-btn btn-practice" style="padding: 15px 30px; font-size: 1rem;" onclick="returnToMenu()">New Problem</button>
                <button class="sidebar-btn btn-quiz" style="padding: 15px 30px; font-size: 1rem;" onclick="retryQuiz()">Practice Again</button>
            </div>
        </div>

    </main>
</div>

<script>
    // --- DATA & CONFIG ---
    const variables = ["x", "\\theta", "t", "\\alpha", "\\beta"];
    
    // Categorized Problems
    // Each problem has a type matching the sidebar categories
    const problemSet = [
        // 1. Reciprocal
        { type: "Reciprocal Identities", gen: (v) => ({ q: `\\csc(${v})`, a: `\\frac{1}{\\sin(${v})}` }), distractors: (v) => [`\\frac{1}{\\cos(${v})}`, `\\sin(${v})`, `\\sec(${v})`] },
        { type: "Reciprocal Identities", gen: (v) => ({ q: `\\frac{1}{\\sec(${v})}`, a: `\\cos(${v})` }), distractors: (v) => [`\\sin(${v})`, `\\csc(${v})`, `\\sec(${v})`] },
        // 1. Quotient
        { type: "Quotient Identities", gen: (v) => ({ q: `\\tan(${v})`, a: `\\frac{\\sin(${v})}{\\cos(${v})}` }), distractors: (v) => [`\\frac{\\cos(${v})}{\\sin(${v})}`, `\\frac{1}{\\sin(${v})}`, `\\sin(${v})`] },
        { type: "Quotient Identities", gen: (v) => ({ q: `\\cot(${v})`, a: `\\frac{\\cos(${v})}{\\sin(${v})}` }), distractors: (v) => [`\\frac{\\sin(${v})}{\\cos(${v})}`, `\\frac{1}{\\cos(${v})}`, `\\cos(${v})`] },
        // 2. Pythagorean
        { type: "Pythagorean Identities", gen: (v) => ({ q: `\\sin^2(${v}) + \\cos^2(${v})`, a: `1` }), distractors: (v) => [`0`, `2`, `\\tan^2(${v})`] },
        { type: "Pythagorean Identities", gen: (v) => ({ q: `1 - \\cos^2(${v})`, a: `\\sin^2(${v})` }), distractors: (v) => [`\\cos^2(${v})`, `-\\sin^2(${v})`, `\\csc^2(${v})`] },
        { type: "Pythagorean Identities", gen: (v) => ({ q: `\\sec^2(${v}) - 1`, a: `\\tan^2(${v})` }), distractors: (v) => [`\\cot^2(${v})`, `1`, `\\csc^2(${v})`] },
        { type: "Pythagorean Identities", gen: (v) => ({ q: `1 + \\cot^2(${v})`, a: `\\csc^2(${v})` }), distractors: (v) => [`\\sec^2(${v})`, `\\tan^2(${v})`, `1`] },
        // 3. Even/Odd
        { type: "Even/Odd Identities", gen: (v) => ({ q: `\\sin(-${v})`, a: `-\\sin(${v})` }), distractors: (v) => [`\\sin(${v})`, `\\cos(${v})`, `-\\cos(${v})`] },
        { type: "Even/Odd Identities", gen: (v) => ({ q: `\\cos(-${v})`, a: `\\cos(${v})` }), distractors: (v) => [`-\\cos(${v})`, `\\sin(${v})`, `-\\sin(${v})`] },
        // 3. Co-Function
        { type: "Co-Function Identities", gen: (v) => ({ q: `\\sin\\left(\\frac{\\pi}{2} - ${v}\\right)`, a: `\\cos(${v})` }), distractors: (v) => [`\\sin(${v})`, `-\\cos(${v})`, `\\csc(${v})`] },
        { type: "Co-Function Identities", gen: (v) => ({ q: `\\tan\\left(\\frac{\\pi}{2} - ${v}\\right)`, a: `\\cot(${v})` }), distractors: (v) => [`-\\tan(${v})`, `\\tan(${v})`, `\\sec(${v})`] },
        // 4. Simplifying
        { type: "Simplifying Expressions", gen: (v) => ({ q: `\\sin(${v}) \\cdot \\csc(${v})`, a: `1` }), distractors: (v) => [`0`, `\\sin^2(${v})`, `\\cos(${v})`] },
        { type: "Simplifying Expressions", gen: (v) => ({ q: `\\tan(${v}) \\cdot \\cos(${v})`, a: `\\sin(${v})` }), distractors: (v) => [`\\cos(${v})`, `1`, `\\csc(${v})`] },
        { type: "Simplifying Expressions", gen: (v) => ({ q: `\\cos(${v}) \\cdot \\sec(${v}) - \\sin^2(${v})`, a: `\\cos^2(${v})` }), distractors: (v) => [`\\sin^2(${v})`, `1`, `0`] },
        { type: "Simplifying Expressions", gen: (v) => ({ q: `\\frac{\\sin(${v})}{\\tan(${v})}`, a: `\\cos(${v})` }), distractors: (v) => [`\\sin(${v})`, `\\sec(${v})`, `1`] },
        { type: "Simplifying Expressions", gen: (v) => ({ q: `\\frac{1 - \\cos^2(${v})}{\\sin(${v})}`, a: `\\sin(${v})` }), distractors: (v) => [`\\cos(${v})`, `\\csc(${v})`, `1`] },
        // 5. Factoring
        { type: "Factoring / Expanding", gen: (v) => ({ q: `(1 - \\sin(${v}))(1 + \\sin(${v}))`, a: `\\cos^2(${v})` }), distractors: (v) => [`\\sin^2(${v})`, `1`, `1 - \\sin(${v})`] },
        { type: "Factoring / Expanding", gen: (v) => ({ q: `(\\sec(${v}) - 1)(\\sec(${v}) + 1)`, a: `\\tan^2(${v})` }), distractors: (v) => [`\\sec^2(${v})`, `1`, `\\cot^2(${v})`] },
        { type: "Factoring / Expanding", gen: (v) => ({ q: `\\sin^4(${v}) - \\cos^4(${v})`, a: `\\sin^2(${v}) - \\cos^2(${v})` }), distractors: (v) => [`1`, `(\\sin(${v})-\\cos(${v}))^2`, `0`] }
    ];

    const uniqueCategories = [...new Set(problemSet.map(p => p.type))];

    // --- STATE ---
    let appState = {
        mode: 'practice', // 'practice' or 'quiz'
        activeTopic: 'all',
        streak: 0,
        answered: false,
        startTime: 0, // for tracking question time
        
        // Quiz specifics
        quizIndex: 0,
        quizLimit: 10,
        quizHistory: [], // Stores { q, userA, correctA, isCorrect, time }
        
        // Scores { 'all': {c:0, t:0}, 'Category': {c:0, t:0} }
        scores: {}
    };

    // Initialize Scores
    appState.scores['all'] = { c: 0, t: 0 };
    uniqueCategories.forEach(cat => appState.scores[cat] = { c: 0, t: 0 });

    // --- DOM REFERENCES ---
    const sidebarList = document.getElementById('category-list');
    const questionCard = document.getElementById('question-card');
    const resultsView = document.getElementById('results-view');
    const questionArea = document.getElementById('question-area');
    const optionsArea = document.getElementById('options-area');
    const nextBtn = document.getElementById('next-btn');
    const streakDisplay = document.getElementById('streak');
    const modeBadge = document.getElementById('mode-badge');
    const progressBar = document.getElementById('quiz-progress-bar');
    const progressFill = document.getElementById('progress-fill');

    // --- INITIALIZATION ---
    function init() {
        // Build Sidebar
        uniqueCategories.forEach(cat => {
            const div = document.createElement('div');
            div.className = 'topic-item';
            div.innerHTML = `
                <div class="topic-header">
                    <span>${cat}</span>
                    <span class="topic-score" id="score-${cat.replace(/\s/g, '')}">0/0</span>
                </div>
                <div class="btn-group">
                    <button class="sidebar-btn btn-practice" onclick="startPractice('${cat}')">Practice</button>
                    <button class="sidebar-btn btn-quiz" onclick="startQuiz('${cat}')">10 Q Quiz</button>
                </div>
            `;
            sidebarList.appendChild(div);
        });

        // Start Default
        startPractice('all');
    }

    // --- MODES ---
    function startPractice(topic) {
        appState.mode = 'practice';
        appState.activeTopic = topic;
        appState.streak = 0;
        
        // UI Reset
        resultsView.style.display = 'none';
        questionCard.style.display = 'block';
        modeBadge.innerText = (topic === 'all' ? 'All Topics' : topic) + " - Practice";
        progressBar.style.display = 'none';
        streakDisplay.innerText = 0;
        
        generateQuestion();
    }

    function startQuiz(topic) {
        appState.mode = 'quiz';
        appState.activeTopic = topic;
        appState.quizIndex = 0;
        appState.quizHistory = [];
        appState.streak = 0;

        // UI Reset
        resultsView.style.display = 'none';
        questionCard.style.display = 'block';
        modeBadge.innerText = (topic === 'all' ? 'All Topics' : topic) + " - Quiz";
        progressBar.style.display = 'block';
        updateProgress();
        streakDisplay.innerText = 0;

        generateQuestion();
    }

    function retryQuiz() {
        startQuiz(appState.activeTopic);
    }

    function returnToMenu() {
        startPractice('all');
    }

    // --- QUESTION GENERATION ---
    function generateQuestion() {
        appState.answered = false;
        nextBtn.classList.remove('show');
        appState.startTime = Date.now();

        // 1. Filter Questions
        let pool = problemSet;
        if (appState.activeTopic !== 'all') {
            pool = problemSet.filter(p => p.type === appState.activeTopic);
        }

        // 2. Select & Randomize
        const template = pool[Math.floor(Math.random() * pool.length)];
        const v = variables[Math.floor(Math.random() * variables.length)];
        
        const qData = template.gen(v);
        const dists = template.distractors(v);

        // 3. Render
        document.getElementById('current-category-display').innerText = template.type;
        questionArea.innerHTML = `\\[ ${qData.q} \\]`;

        // 4. Options
        let options = [
            { latex: qData.a, isCorrect: true },
            { latex: dists[0], isCorrect: false },
            { latex: dists[1], isCorrect: false },
            { latex: dists[2], isCorrect: false }
        ];
        
        // Shuffle options
        for (let i = options.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [options[i], options[j]] = [options[j], options[i]];
        }

        optionsArea.innerHTML = '';
        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerHTML = `\\( ${opt.latex} \\)`;
            // Store raw latex for results table
            btn.dataset.latex = opt.latex;
            btn.onclick = () => handleAnswer(btn, opt.isCorrect, qData.q, qData.a);
            optionsArea.appendChild(btn);
        });

        // 5. Typeset & Animate
        MathJax.typesetPromise();
        questionArea.classList.remove('fade-in');
        void questionArea.offsetWidth;
        questionArea.classList.add('fade-in');

        // Update Quiz Progress Bar
        if(appState.mode === 'quiz') updateProgress();
    }

    // --- ANSWER HANDLING ---
    function handleAnswer(btn, isCorrect, questionLatex, correctLatex) {
        if (appState.answered) return;
        appState.answered = true;

        const timeTaken = ((Date.now() - appState.startTime) / 1000).toFixed(1);

        // Visual Feedback
        if (isCorrect) {
            btn.classList.add('correct');
            appState.streak++;
            triggerConfetti();
        } else {
            btn.classList.add('wrong');
            appState.streak = 0;
            // Highlight correct answer
            document.querySelectorAll('.option-btn').forEach(b => {
                // Determine which button has the correct latex by comparison or data-attribute logic?
                // Simplest: we know the correct answer logic.
                // But we didn't store isCorrect in DOM. Let's find button with matching Correct latex? 
                // Wait, we passed isCorrect in closure. But we need to find the DOM element.
                // We'll iterate buttons and use MathJax checking or just logic.
                // Better: Just check correctLatex vs stored dataset.
                if(b.dataset.latex === correctLatex) b.classList.add('correct');
            });
        }
        streakDisplay.innerText = appState.streak;

        // Update Score Data
        updateScore(isCorrect);

        // Handle Mode Logic
        if (appState.mode === 'quiz') {
            // Save to history
            appState.quizHistory.push({
                num: appState.quizIndex + 1,
                q: questionLatex,
                userA: btn.dataset.latex,
                correctA: correctLatex,
                isCorrect: isCorrect,
                time: timeTaken
            });

            appState.quizIndex++;
            updateProgress();

            if (appState.quizIndex >= appState.quizLimit) {
                // Quiz Over
                setTimeout(showResults, 1000);
            } else {
                setTimeout(generateQuestion, 1000); // Auto advance in quiz
            }
        } else {
            // Practice Mode - Show Next Button
            nextBtn.classList.add('show');
        }
    }

    function nextQuestion() {
        generateQuestion();
    }

    function updateScore(isCorrect) {
        // Update All
        appState.scores['all'].t++;
        if (isCorrect) appState.scores['all'].c++;
        document.getElementById('score-all').innerText = `${appState.scores['all'].c}/${appState.scores['all'].t}`;

        // Update Specific Topic (if not mixed)
        if (appState.activeTopic !== 'all') {
            const stats = appState.scores[appState.activeTopic];
            stats.t++;
            if (isCorrect) stats.c++;
            const id = 'score-' + appState.activeTopic.replace(/\s/g, '');
            const el = document.getElementById(id);
            if(el) el.innerText = `${stats.c}/${stats.t}`;
        }
    }

    function updateProgress() {
        const pct = (appState.quizIndex / appState.quizLimit) * 100;
        progressFill.style.width = `${pct}%`;
    }

    // --- RESULTS VIEW ---
    function showResults() {
        questionCard.style.display = 'none';
        resultsView.style.display = 'block';

        const correctCount = appState.quizHistory.filter(x => x.isCorrect).length;
        const totalTime = appState.quizHistory.reduce((acc, curr) => acc + parseFloat(curr.time), 0).toFixed(1);

        document.getElementById('results-summary-text').innerText = 
            `Score: ${correctCount}/${appState.quizLimit} | Total Time: ${totalTime}s`;

        const tbody = document.getElementById('results-body');
        tbody.innerHTML = '';

        appState.quizHistory.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row.num}</td>
                <td>\\(${row.q}\\)</td>
                <td>\\(${row.userA}\\)</td>
                <td>\\(${row.correctA}\\)</td>
                <td><span class="status-icon ${row.isCorrect ? 'status-check' : 'status-x'}">${row.isCorrect ? '✓' : '✗'}</span></td>
                <td><span class="time-pill">${row.time}s</span></td>
            `;
            tbody.appendChild(tr);
        });

        // Trigger confetti if score is good
        if(correctCount >= 7) triggerConfetti();

        MathJax.typesetPromise();
    }

    // --- UTILS ---
    function triggerConfetti() {
        confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 },
            colors: ['#6366f1', '#a855f7', '#ec4899']
        });
    }

    // Boot
    window.onload = init;

</script>
</body>
</html>
